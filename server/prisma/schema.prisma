// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// System-wide state tracking
model SystemState {
  id            String   @id @default("global")
  jackpot       Float    @default(0)
  tvl           Float    @default(0)
  totalVolume   Float    @default(0)
  totalHands    Int      @default(0)  // Added for Issue #2
  activePlayers Int      @default(0)
  communityPool Float    @default(0)  // Community/Global Partner Pool
  updatedAt     DateTime @updatedAt
}

// User Accounts (Wallet-based)
model User {
  id              String        @id // Wallet address
  walletAddress   String        @unique // Explicit wallet field for easier access
  username        String        @unique
  email           String?       @unique
  avatarUrl       String?
  coverUrl        String?       // Profile cover image URL
  bio             String?
  balance         Float         @default(0)
  totalWinnings   Float         @default(0)
  totalHands      Int           @default(0)
  vipRank         Int           @default(0) // 0=None, 1-3=VIP levels
  isVerified      Boolean       @default(false)
  referralCode    String?       @unique
  referredBy      String?       // Who referred this user (referral code)
  referralRank    Int           @default(0) // 0=Scout, 1=Agent, 2=Broker, 3=Partner
  hostRank        Int           @default(0) // 0=Dealer to 4=Mogul
  hostEarnings    Float         @default(0) // Lifetime host revenue earnings
  
  // Blockchain Sync Fields
  onChainBalance  Float         @default(0)     // On-chain SOL/token balance
  walletVerified  Boolean       @default(false) // Did we verify ownership?
  lastChainSync   DateTime?                     // Last blockchain sync timestamp
  
  // Relationships
  transactions    Transaction[]
  hands           Hand[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([username])
  @@index([walletAddress])
  @@index([totalWinnings])
  @@index([walletVerified])
}

// Transaction Log
model Transaction {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          String   // GAME_BUYIN, GAME_WIN, WITHDRAWAL, DEPOSIT, RAKE, JACKPOT, etc.
  amount        Float
  status        String   @default("COMPLETED") // COMPLETED, PENDING, FAILED
  
  // Blockchain Tracking
  chainTxHash   String?                    // Solana transaction signature
  chainStatus   String   @default("PENDING") // PENDING|CONFIRMED|FAILED
  
  // Game Context
  handId        String?                    // Link to Hand record if game-related
  hand          Hand?    @relation(fields: [handId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([createdAt])
  @@index([chainTxHash])
  @@index([handId])
}

// Hand History for Fairness Verification
model Hand {
  id                String     @id @default(cuid())
  userId            String
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tableId           String
  handNumber        Int
  
  // Players & Results
  winnerIds         String     // JSON array of wallet addresses
  potAmount         Float
  rakeAmount        Float      @default(0)
  
  // Game State
  communityCards    String     // JSON serialized: CardData[]
  finalBoardState   String?    // JSON of final GameState
  
  // Fairness & Verification
  fairnessHash      String     // Server seed hash (public)
  fairnessReveal    String?    // Server seed reveal (after hand ends)
  clientSeed        String?    // Client seed
  nonce             Int?       // Hand sequence number
  
  // Transactions
  transactions      Transaction[]
  
  createdAt         DateTime   @default(now())
  
  @@index([userId])
  @@index([tableId])
  @@index([handNumber])
  @@index([createdAt])
}

// Rake Distribution Tracking
model RakeDistribution {
  id              String   @id @default(cuid())
  handId          String
  totalRake       Float
  hostShare       Float
  hostUserId      String?
  hostTier        Int      @default(0)
  referrerShare   Float
  referrerUserId  String?
  referrerRank    Int      @default(0)
  jackpotShare    Float
  globalPoolShare Float
  developerShare  Float
  createdAt       DateTime @default(now())

  @@index([handId])
  @@index([hostUserId])
  @@index([referrerUserId])
  @@index([createdAt])
}

// Tournament System - REMOVED (not ready for production)
